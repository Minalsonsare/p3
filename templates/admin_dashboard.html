<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Console - Job Card App</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Custom Styles -->
<style>
    /* (Keep all existing styles from previous version - they are fine) */
    :root { --bs-primary-rgb: 0, 123, 255; --bs-link-color: #0056b3; --bs-link-hover-color: #003d80; }
    body { background-color: #f8f9fa; font-family: 'Roboto', sans-serif; color: #343a40; }
    .sidebar { background-color: #ffffff; height: 100vh; padding: 1.5rem 1rem; border-right: 1px solid #dee2e6; position: fixed; width: 240px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 1000; }
    .sidebar .logo { display: block; margin: 0 auto 1.5rem auto; text-align: center; }
    .sidebar a { display: flex; align-items: center; padding: 0.8rem 1rem; margin-bottom: 0.5rem; color: #495057; text-decoration: none; border-radius: 8px; font-weight: 500; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
    .sidebar a:hover { background-color: #e9ecef; color: #007bff; }
    .sidebar a.active { background-color: #007BFF; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3); }
    .sidebar a i { margin-right: 0.8rem; font-size: 1.1rem; width: 20px; text-align: center; transition: transform 0.2s ease; }
    .sidebar a:hover i { transform: scale(1.1); }
    .dashboard-content { margin-left: 240px; padding: 2rem; }
    .content-section { padding: 25px; background-color: #ffffff; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.075); border: 1px solid #dee2e6; display: none; }
    .content-section.active { display: block; }
    .section-header h2, .content-section h2 { color: #0056b3; margin-bottom: 0.5rem; display: flex; align-items: center; font-weight: 500; font-size: 1.5rem; }
    .section-header h2 i, .content-section h2 i { margin-right: 0.6rem; color: #007bff; }
    .section-header hr, .content-section hr { margin-top: 0.5rem; margin-bottom: 1.5rem; border-top: 1px solid #dee2e6; }
    .card { border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; background-color: #ffffff; overflow: hidden; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .card h5.card-title { color: #0056b3; font-weight: 500; font-size: 1.1rem; }
    .card .badge { font-size: 0.7rem; vertical-align: middle; margin-left: 5px; padding: 0.3em 0.5em; font-weight: 500; }
    .badge.bg-info { background-color: #17a2b8 !important; color: white !important; }
    .badge.bg-success { background-color: #28a745 !important; color: white !important; }
    .badge.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
    .badge.bg-danger { background-color: #dc3545 !important; color: white !important; }
    .badge.bg-primary { background-color: #0d6efd !important; color: white !important; }
    .navbar { background-color: #ffffff !important; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.04); margin-bottom: 2rem; }
    .navbar-brand { font-weight: 500; color: #0056b3 !important; }
    .modal-header { background-color: #e9ecef; border-bottom: 1px solid #dee2e6; padding: 1rem 1.5rem; }
    .modal-title { color: #343a40; font-weight: 500; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 0.75rem 1.5rem; }
    .form-label .text-danger { font-size: 0.9em; vertical-align: super; }
    .table { border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; font-size: 0.9rem;}
    .table thead th { background-color: #f8f9fa; color: #495057; font-weight: 600; border-bottom: 2px solid #dee2e6; white-space: nowrap; }
    .table tbody tr { border-top: 1px solid #dee2e6; }
    .table tbody tr:first-child { border-top: none; }
    .table-hover > tbody > tr:hover { background-color: #eef2f7; }
    .table .btn-sm i { font-size: 1rem; }
    .table .btn-outline-primary { font-size: 0.8rem; padding: 0.2rem 0.5rem;}
    .table .btn-outline-danger { font-size: 0.8rem; padding: 0.2rem 0.5rem; }
    .text-muted-light { color: #86909c !important; }
    .user-select-all { user-select: all; }
    .spinner-border-sm { width: 1rem; height: 1rem; }
    .alert { font-size: 0.9rem; }
    #editUserPermissionsContainer .card-header { padding: 0.75rem 1rem; background-color: #f8f9fa; } /* Light background for header */
    #editUserPermissionsContainer .card-body { padding: 1rem; max-height: 200px; overflow-y: auto; }
    #editUserPermissionsContainer .form-check-inline { margin-right: 1rem; margin-bottom: 0.5rem;}
    #editUserPermissionsContainer .form-switch .form-check-label { cursor: pointer; } /* Improve switch usability */

</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <div class="logo">
         <img src="{{ url_for('static', filename='Group 1000008859.png') }}" alt="Logo" height="45">
    </div>
    <a href="#dashboard" class="nav-link active" data-target="dashboard-section" id="nav-dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a href="#users" class="nav-link" data-target="users-section" id="nav-users"><i class="bi bi-people-fill"></i> Manage Users</a>
    {# Removed Manage Criteria Link #}
    <a href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Logout</a>
</div>

<!-- Main Content Area -->
<div class="dashboard-content">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand ms-2" href="#">AI Job Card - Admin Console</a>
             <span class="navbar-text ms-auto">
                Welcome, {{ session.get('username', 'Admin') }}!
             </span>
        </div>
    </nav>

    <div id="flash-message-container" class="mb-3">
         {% include '_flash_messages.html' %}
    </div>

    <!-- Dashboard Section -->
    <section id="dashboard-section" class="content-section active">
         <div class="section-header">
            <h2><i class="bi bi-speedometer2"></i> Dashboard</h2><hr>
        </div>
        <p class="lead text-muted-light mb-4">Overview of system users.</p> {# Removed criteria count text #}
         <div class="row justify-content-center"> {# Center the remaining card #}
            <div class="col-lg-8 mb-4"> {# Adjusted width #}
                <div class="card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-between p-4">
                        <div>
                            <h5 class="card-title mb-3"><i class="bi bi-people-fill me-2"></i> Managed Users</h5>
                            <p class="card-text display-4 fw-bold text-primary" id="user-count">...</p>
                        </div>
                        <button class="btn btn-outline-primary mt-3" data-target="users-section" data-nav-target="nav-users">Manage Users <i class="bi bi-arrow-right-short"></i></button>
                    </div>
                </div>
            </div>
             {# Removed Criteria Count Card #}
        </div>
    </section>

    <!-- User Management Section -->
    <section id="users-section" class="content-section">
        <div class="section-header d-flex justify-content-between align-items-center flex-wrap">
            <h2><i class="bi bi-people-fill"></i> User Management</h2>
             <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="bi bi-plus-circle me-1"></i> Create New User
            </button>
        </div>
         <hr>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="user-table-body">
                    <tr><td colspan="4" class="text-center text-muted py-5"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading users...</td></tr>
                </tbody>
            </table>
        </div>
         <p id="no-users-message" class="text-center text-muted mt-4 py-3 bg-light rounded" style="display: none;"><i class="bi bi-info-circle me-1"></i> No users found.</p>
    </section>

    <!-- Criteria Management Section REMOVED -->
    <!-- <section id="porder-section" class="content-section"> ... </section> -->

</div> <!-- /dashboard-content -->

<!-- MODALS -->
<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel"><i class="bi bi-person-plus-fill me-2"></i> Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" role="alert" id="user-form-alert"></div>
                <form id="createUserForm" novalidate>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" required>
                        <div class="invalid-feedback">Please provide a username.</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="invalid-feedback">Please provide a valid email address.</div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="password" required>
                        <div class="invalid-feedback">Please provide a password.</div>
                        <small class="form-text text-muted">User should change this password after first login.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign Initial Access Privileges <span class="text-danger">*</span></label>
                        <div id="privilege-feedback" class="text-danger small mb-2 d-none">Please select at least one privilege.</div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="admin" id="priv-admin" name="userPrivilege">
                            <label class="form-check-label" for="priv-admin">Admin (Full System Access)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="po-verifier" id="priv-po-verify" name="userPrivilege">
                            <label class="form-check-label" for="priv-po-verify">PO Verifier</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="ats-verifier" id="priv-ats-verify" name="userPrivilege">
                            <label class="form-check-label" for="priv-ats-verify">ATS Verifier</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="part-drawing-verifier" id="priv-part-drawing-verify" name="userPrivilege">
                            <label class="form-check-label" for="priv-part-drawing-verify">Part Drawing Verifier</label>
                        </div>
                         <small class="form-text text-muted mt-2">Select privileges to grant initial access. Detailed field access is managed via 'Edit User'.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="createUserForm" id="createUserSubmitBtn">
                    <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span>
                    <i class="bi bi-check-circle me-1"></i> Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Criteria Modal REMOVED -->
<!-- <div class="modal fade" id="createCriteriaModal" ...> ... </div> -->

<!-- Edit User Modal (Keep As Is) -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel"><i class="bi bi-person-gear me-2"></i> Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" role="alert" id="edit-user-form-alert"></div>
                <form id="editUserForm" novalidate>
                    <input type="hidden" id="editUserEmail" name="email">

                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editUsername" required>
                        <div class="invalid-feedback">Please provide a username.</div>
                    </div>

                    <div class="mb-3">
                        <label for="displayEmail" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="displayEmail" readonly disabled>
                        <small class="form-text text-muted">Email address cannot be changed.</small>
                    </div>

                    <hr>
                    <h6 class="mb-3">Tab Access & Field Permissions:</h6>
                    <div id="editUserPermissionsContainer" class="mb-3">
                        <p class="text-muted">Loading permissions...</p>
                    </div>
                    <div id="edit-privilege-feedback" class="text-danger small mb-2 d-none">User must have access to at least one tab.</div>

                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Password Management:</h6>
                        <button type="button" class="btn btn-sm btn-outline-warning" id="resetPasswordBtn">
                            <i class="bi bi-key-fill me-1"></i> Reset Password
                        </button>
                    </div>
                    <div id="resetPasswordResult" class="mt-2 small">
                        <!-- Password reset results here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="editUserForm" id="saveUserChangesBtn">
                    <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span>
                    <i class="bi bi-check-circle me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Inject Python Data into JS -->
<script>
  // Directly assign the JavaScript object rendered by |tojson|safe
    // No JSON.parse needed, no surrounding quotes needed for the Jinja expression
    const AVAILABLE_TABS_PY = {{ available_tabs_data | tojson | safe }};
    const MASTER_FIELD_DEFINITIONS_PY = {{ master_field_definitions_data | tojson | safe }};
</script>

<!-- Custom Functional JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Get Elements ---
        const sidebarLinks = document.querySelectorAll('.sidebar a[data-target]');
        const contentSections = document.querySelectorAll('.dashboard-content > .content-section');
        const userTableBody = document.getElementById('user-table-body');
        const noUsersMessage = document.getElementById('no-users-message');
         
        // REMOVED Criteria Elements
        // const poCriteriaList = ...;
        // const atsCriteriaList = ...;
        // etc.

        const createUserForm = document.getElementById('createUserForm');
        // REMOVED createCriteriaForm = ...;

        const userFormAlert = document.getElementById('user-form-alert');
        // REMOVED criteriaFormAlert = ...;
        const privilegeFeedback = document.getElementById('privilege-feedback');
        // REMOVED criteriaTypeFilterButtons = ...;
        // REMOVED addCriteriaButtons = ...;
        const flashContainer = document.getElementById('flash-message-container');
        const userCountEl = document.getElementById('user-count');
        // REMOVED criteriaCountEl = ...;
        const createUserSubmitBtn = document.getElementById('createUserSubmitBtn');
        // REMOVED saveCriteriaSubmitBtn = ...;

        // Modal Instances
        const createUserModalEl = document.getElementById('createUserModal');
        const createUserModalInstance = createUserModalEl ? bootstrap.Modal.getOrCreateInstance(createUserModalEl) : null;
        // REMOVED createCriteriaModalEl = ...;
        // REMOVED createCriteriaModalInstance = ...;

        // Edit User Modal Elements (Keep these)
        const editUserModalEl = document.getElementById('editUserModal');
        const editUserModalInstance = editUserModalEl ? bootstrap.Modal.getOrCreateInstance(editUserModalEl) : null;
        const editUserForm = document.getElementById('editUserForm');
        const editUsernameInput = document.getElementById('editUsername');
        const displayEmailInput = document.getElementById('displayEmail');
        const editUserEmailInput = document.getElementById('editUserEmail');
        const editUserPermissionsContainer = document.getElementById('editUserPermissionsContainer');
        const editUserFormAlert = document.getElementById('edit-user-form-alert');
        const editPrivilegeFeedback = document.getElementById('edit-privilege-feedback');
        const resetPasswordBtn = document.getElementById('resetPasswordBtn');
        const resetPasswordResultEl = document.getElementById('resetPasswordResult');
        const saveUserChangesBtn = document.getElementById('saveUserChangesBtn');

        // State variables
        let currentUserEmailForEdit = null;
        // REMOVED currentCriteriaFilter, allCriteriaData

        // --- Helper Functions (Keep escapeHTML, showFlashMessage, showAlert, hideAlert, toggleButtonSpinner) ---
        function escapeHTML(str) { /* (Keep implementation) */
            if (str === null || typeof str === 'undefined') return '';
             const div = document.createElement('div');
             div.textContent = str;
             return div.innerHTML;
        }
        function showFlashMessage(message, category = 'info') { /* (Keep implementation) */
             if (!flashContainer) return;
            const alertClass = `alert-${category}`;
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            flashContainer.insertAdjacentHTML('beforeend', alertHtml);
        }
        function showAlert(alertElement, message, type = 'danger') { /* (Keep implementation) */
            if (!alertElement) return;
            alertElement.className = `alert alert-${type} mb-3`;
            alertElement.innerHTML = escapeHTML(message);
            alertElement.classList.remove('d-none');
         }
        function hideAlert(alertElement) { /* (Keep implementation) */
             if (!alertElement) return;
             alertElement.classList.add('d-none');
             alertElement.innerHTML = '';
        }
        function toggleButtonSpinner(button, showSpinner) { /* (Keep implementation) */
            if (!button) return;
            const spinner = button.querySelector('.spinner-border');
            const icon = button.querySelector('i');
            if (!spinner) return;
            if (showSpinner) {
                spinner.classList.remove('d-none');
                if(icon) icon.classList.add('d-none');
                button.disabled = true;
            } else {
                spinner.classList.add('d-none');
                if(icon) icon.classList.remove('d-none');
                button.disabled = false;
            }
         }
        // --- Simplified updateDashboardCounts (Only User Count) ---
         function updateDashboardCounts() {
             if (userCountEl && userTableBody) {
                 const placeholderRow = userTableBody.querySelector('td[colspan="4"]');
                 userCountEl.textContent = placeholderRow ? 0 : userTableBody.rows.length;
             }
             // criteriaCountEl is removed
         }

        // --- Navigation ---
        function showSection(targetId) { /* UPDATE: Remove criteria loading */
             contentSections.forEach(section => { section.classList.remove('active'); });
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                 targetSection.classList.add('active');
                 if (targetId === 'users-section' && userTableBody) loadUsers();
                 // Removed: if (targetId === 'porder-section') loadCriteria();
            } else {
                document.getElementById('dashboard-section')?.classList.add('active');
            }
            sidebarLinks.forEach(link => {
                 link.classList.toggle('active', link.getAttribute('data-target') === targetId);
            });
         }
        sidebarLinks.forEach(link => { /* (Keep implementation) */
            link.addEventListener('click', (event) => {
                event.preventDefault();
                const targetId = link.getAttribute('data-target');
                if (targetId) showSection(targetId);
            });
         });
        document.querySelectorAll('.card button[data-target]').forEach(button => { /* (Keep implementation) */
             button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                if (targetId) showSection(targetId);
            });
        });

        // --- User Management (Keep as is, including Edit User logic) ---
        async function loadUsers() { /* (Keep implementation) */
            if (!userTableBody) return;
            userTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-5"><div class="spinner-border spinner-border-sm me-2"></div> Loading...</td></tr>';
            if(noUsersMessage) noUsersMessage.style.display = 'none';
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) throw new Error(`Error loading users: ${response.statusText}`);
                const users = await response.json();
                userTableBody.innerHTML = '';
                if (users && users.length > 0) {
                    users.forEach(user => renderUserRow(user));
                    if(noUsersMessage) noUsersMessage.style.display = 'none';
                } else {
                    if(noUsersMessage) noUsersMessage.style.display = 'block';
                }
                updateDashboardCounts(); // Update user count
            } catch (error) {
                userTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Failed to load users.</td></tr>';
                showFlashMessage(error.message, 'danger');
            }
        }
        function renderUserRow(user) { /* (Keep implementation with Edit button) */
             const roleDisplay = (user.role || 'N/A').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            let badgeClass = 'bg-secondary';
            if (user.role === 'admin') badgeClass = 'bg-danger';
            else if (user.role === 'subadmin') badgeClass = 'bg-warning text-dark';
            else if (user.role === 'po_verifier') badgeClass = 'bg-info';
            else if (user.role === 'ats_verifier') badgeClass = 'bg-success';
            else if (user.role === 'part_drawing_verifier') badgeClass = 'bg-primary';

            const row = `
                <tr>
                    <td>${escapeHTML(user.username)}</td>
                    <td>${escapeHTML(user.email)}</td>
                    <td><span class="badge ${badgeClass}">${escapeHTML(roleDisplay)}</span></td>
                   <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary me-1 btn-edit-user" data-bs-toggle="modal" data-bs-target="#editUserModal" data-email="${escapeHTML(user.email)}" title="Edit User">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete-user" data-email="${escapeHTML(user.email)}" title="Delete User">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </td>
                </tr>`;
            if (userTableBody) userTableBody.insertAdjacentHTML('beforeend', row);
        }
        if (createUserForm) { /* (Keep implementation) */
            createUserForm.addEventListener('submit', async (event) => {
                event.preventDefault(); event.stopPropagation();
                hideAlert(userFormAlert);
                if(privilegeFeedback) privilegeFeedback.classList.add('d-none');
                const selectedPrivileges = Array.from(createUserForm.querySelectorAll('input[name="userPrivilege"]:checked')).map(cb => cb.value);
                let isFormValid = createUserForm.checkValidity();
                let arePrivilegesValid = selectedPrivileges.length > 0;
                if (!arePrivilegesValid && privilegeFeedback) {
                    privilegeFeedback.classList.remove('d-none');
                    isFormValid = false;
                }
                if (!isFormValid) { createUserForm.classList.add('was-validated'); return; }
                createUserForm.classList.remove('was-validated');

                const username = document.getElementById('username').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                toggleButtonSpinner(createUserSubmitBtn, true);
                try {
                    const response = await fetch('/api/admin/users', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, email, password, privileges: selectedPrivileges })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `Request failed`);
                    if(createUserModalInstance) createUserModalInstance.hide();
                    loadUsers();
                    showFlashMessage(`User '${escapeHTML(result.user.username)}' created.`, 'success');
                } catch (error) { showAlert(userFormAlert, error.message, 'danger');
                } finally { toggleButtonSpinner(createUserSubmitBtn, false); }
            });
        }
        if (userTableBody) { /* (Keep implementation with Edit listener) */
            userTableBody.addEventListener('click', async (event) => {
                const deleteButton = event.target.closest('.btn-delete-user');
                if (deleteButton) { /* (Keep delete logic) */
                    const userEmail = deleteButton.dataset.email;
                    if (confirm(`Delete user ${userEmail}? This cannot be undone.`)) {
                        toggleButtonSpinner(deleteButton, true);
                        try {
                            const response = await fetch(`/api/admin/users/${encodeURIComponent(userEmail)}`, { method: 'DELETE' });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.error || `Failed to delete`);
                            loadUsers(); showFlashMessage(result.message, 'success');
                        } catch (error) { showFlashMessage(`Error: ${error.message}`, 'danger'); toggleButtonSpinner(deleteButton, false); }
                    }
                 }
                 const editButton = event.target.closest('.btn-edit-user');
                 if (editButton) { /* (Keep edit logic) */
                    const userEmail = editButton.dataset.email;
                    if (userEmail && editUserModalInstance) {
                        loadAndShowEditUserModal(userEmail);
                    } else if (!editUserModalInstance) { console.error("Edit user modal instance not found"); }
                }
            });
        }
        if(createUserModalEl) { /* (Keep implementation) */
             createUserModalEl.addEventListener('hidden.bs.modal', () => {
                if(createUserForm) {
                    createUserForm.reset();
                    createUserForm.classList.remove('was-validated');
                }
                hideAlert(userFormAlert);
                if(privilegeFeedback) privilegeFeedback.classList.add('d-none');
            });
        }

        // --- Edit User Modal Logic (Keep As Is) ---
        function populateEditUserPermissions(currentUserPermissions = {}) { /* (Keep implementation) */
             if (!editUserPermissionsContainer) return;
            editUserPermissionsContainer.innerHTML = '';
            if (!AVAILABLE_TABS_PY || Object.keys(AVAILABLE_TABS_PY).length === 0) {
                editUserPermissionsContainer.innerHTML = '<p class="text-danger">Error: Tab definitions not loaded.</p>'; return;
            }
            for (const tabId in AVAILABLE_TABS_PY) {
                if (!AVAILABLE_TABS_PY.hasOwnProperty(tabId)) continue;
                const tabConfig = AVAILABLE_TABS_PY[tabId];
                const userTabPerms = currentUserPermissions[tabId] || { can_access: false, allowed_fields: [] };
                let tabHtml = `<div class="card mb-3"><div class="card-header bg-light"><div class="form-check form-switch"><input class="form-check-input tab-access-checkbox" type="checkbox" role="switch" value="${tabId}" id="tab-access-${tabId}" name="tabAccess" ${userTabPerms.can_access ? 'checked' : ''}><label class="form-check-label fw-bold" for="tab-access-${tabId}"><i class="${tabConfig.icon || 'bi bi-folder'} me-1"></i> ${escapeHTML(tabConfig.name)}</label></div></div><div class="card-body field-permissions-container ${userTabPerms.can_access ? '' : 'd-none'}"><h6>Allowed Fields for ${escapeHTML(tabConfig.name)}:</h6><div class="mb-2"><button type="button" class="btn btn-sm btn-outline-secondary btn-select-all-fields" data-tab-id="${tabId}">Select All</button> <button type="button" class="btn btn-sm btn-outline-secondary btn-deselect-all-fields" data-tab-id="${tabId}">Deselect All</button></div>`;
                const masterFields = MASTER_FIELD_DEFINITIONS_PY[tabId];
                if (masterFields && masterFields.length > 0) {
                    masterFields.forEach(fieldDef => {
                        const isFieldAllowed = Array.isArray(userTabPerms.allowed_fields) && userTabPerms.allowed_fields.includes(fieldDef.id);
                        tabHtml += `<div class="form-check form-check-inline"><input class="form-check-input field-permission-checkbox" type="checkbox" id="field-${tabId}-${fieldDef.id}" value="${fieldDef.id}" data-tab-id="${tabId}" ${isFieldAllowed ? 'checked' : ''} ${!userTabPerms.can_access ? 'disabled' : ''}><label class="form-check-label small" for="field-${tabId}-${fieldDef.id}" title="${escapeHTML(fieldDef.description || '')}">${escapeHTML(fieldDef.label)}</label></div>`;
                    });
                } else { tabHtml += '<p class="text-muted small">No specific fields defined.</p>'; }
                tabHtml += `</div></div>`;
                editUserPermissionsContainer.insertAdjacentHTML('beforeend', tabHtml);
            }
            editUserPermissionsContainer.querySelectorAll('.tab-access-checkbox').forEach(cb => { /* (Keep implementation) */
                 cb.addEventListener('change', function() {
                    const fieldContainer = this.closest('.card').querySelector('.field-permissions-container');
                    const fieldCheckboxes = fieldContainer.querySelectorAll('.field-permission-checkbox');
                    if (this.checked) {
                        fieldContainer.classList.remove('d-none');
                        fieldCheckboxes.forEach(fc => fc.disabled = false);
                    } else {
                        fieldContainer.classList.add('d-none');
                        fieldCheckboxes.forEach(fc => fc.disabled = true);
                    }
                });
             });
             editUserPermissionsContainer.querySelectorAll('.btn-select-all-fields').forEach(btn => { /* (Keep implementation) */
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tabId;
                    editUserPermissionsContainer.querySelectorAll(`.field-permission-checkbox[data-tab-id="${tabId}"]`).forEach(fc => fc.checked = true);
                });
            });
             editUserPermissionsContainer.querySelectorAll('.btn-deselect-all-fields').forEach(btn => { /* (Keep implementation) */
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tabId;
                     editUserPermissionsContainer.querySelectorAll(`.field-permission-checkbox[data-tab-id="${tabId}"]`).forEach(fc => fc.checked = false);
                });
            });
        }
        async function loadAndShowEditUserModal(userEmail) { /* (Keep implementation) */
            currentUserEmailForEdit = userEmail;
            if(editUserEmailInput) editUserEmailInput.value = userEmail;
            if(resetPasswordResultEl) resetPasswordResultEl.innerHTML = '';
            hideAlert(editUserFormAlert);
            if(editPrivilegeFeedback) editPrivilegeFeedback.classList.add('d-none');
            toggleButtonSpinner(saveUserChangesBtn, true);
            try {
                const response = await fetch(`/api/admin/users/${encodeURIComponent(userEmail)}`);
                if (!response.ok) { const err = await response.json().catch(() => ({ error: `Failed to load user data (${response.status})` })); throw new Error(err.error || `Failed to load user data (${response.status})`); }
                const userData = await response.json();
                if(!userData) throw new Error("Received empty user data from server.");
                if(editUsernameInput) editUsernameInput.value = userData.username || '';
                if(displayEmailInput) displayEmailInput.value = userData.email || '';
                const permissions = userData.permissions || {};
                for (const tabId in AVAILABLE_TABS_PY) {
                    if (!permissions[tabId]) permissions[tabId] = { can_access: false, allowed_fields: [] };
                    else if(!Array.isArray(permissions[tabId].allowed_fields)) permissions[tabId].allowed_fields = [];
                }
                populateEditUserPermissions(permissions);
            } catch (error) { console.error("Load user for edit error:", error); showAlert(editUserFormAlert, error.message, 'danger'); }
            finally { toggleButtonSpinner(saveUserChangesBtn, false); }
        }
        if (editUserForm) { /* (Keep implementation) */
             editUserForm.addEventListener('submit', async (event) => {
                event.preventDefault(); event.stopPropagation();
                hideAlert(editUserFormAlert);
                if(editPrivilegeFeedback) editPrivilegeFeedback.classList.add('d-none');
                let isFormValid = editUserForm.checkValidity();
                const assignedTabs = Array.from(editUserPermissionsContainer.querySelectorAll('.tab-access-checkbox:checked'));
                if (assignedTabs.length === 0 && editPrivilegeFeedback) {
                    editPrivilegeFeedback.textContent = "User must have access to at least one tab.";
                    editPrivilegeFeedback.classList.remove('d-none'); isFormValid = false;
                }
                if (!isFormValid) { editUserForm.classList.add('was-validated'); return; }
                editUserForm.classList.remove('was-validated');
                const updatedUsername = editUsernameInput.value.trim();
                const permissionsToSave = {};
                editUserPermissionsContainer.querySelectorAll('.card').forEach(card => {
                    const tabCheckbox = card.querySelector('.tab-access-checkbox');
                    const tabId = tabCheckbox.value;
                    const canAccess = tabCheckbox.checked;
                    let allowedFieldsForTab = [];
                    if (canAccess) { card.querySelectorAll('.field-permission-checkbox:checked').forEach(fc => allowedFieldsForTab.push(fc.value)); }
                    permissionsToSave[tabId] = { can_access: canAccess, allowed_fields: allowedFieldsForTab };
                });
                const payload = { username: updatedUsername, permissions: permissionsToSave };
                toggleButtonSpinner(saveUserChangesBtn, true);
                try {
                    const response = await fetch(`/api/admin/users/${encodeURIComponent(currentUserEmailForEdit)}`, {
                        method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `Failed to update user`);
                    if(editUserModalInstance) editUserModalInstance.hide();
                    loadUsers(); showFlashMessage(result.message || `User updated.`, 'success');
                } catch (error) { showAlert(editUserFormAlert, error.message, 'danger'); }
                finally { toggleButtonSpinner(saveUserChangesBtn, false); }
            });
        }
        if (resetPasswordBtn) { /* (Keep implementation) */
             resetPasswordBtn.addEventListener('click', async () => {
                if (!currentUserEmailForEdit) return;
                if (!confirm(`Are you sure you want to reset the password for ${currentUserEmailForEdit}?`)) return;
                resetPasswordBtn.disabled = true;
                if(resetPasswordResultEl) resetPasswordResultEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div><span class="text-muted ms-1">Resetting...</span>';
                try {
                    const response = await fetch(`/api/admin/users/${encodeURIComponent(currentUserEmailForEdit)}/reset-password`, { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `Password reset failed (${response.status})`);
                    if(resetPasswordResultEl) resetPasswordResultEl.innerHTML = `<div class="alert alert-success alert-dismissible fade show mt-2" role="alert"><i class="bi bi-check-circle-fill me-2"></i> ${escapeHTML(result.message)} <br> Temp Password: <strong class="user-select-all ms-1">${escapeHTML(result.temporary_password)}</strong><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                } catch (error) { if(resetPasswordResultEl) resetPasswordResultEl.innerHTML = `<div class="alert alert-danger mt-2">${escapeHTML(error.message)}</div>`; }
                finally { resetPasswordBtn.disabled = false; }
            });
        }
        if(editUserModalEl) { /* (Keep implementation) */
            editUserModalEl.addEventListener('hidden.bs.modal', () => {
                if(editUserForm) { editUserForm.reset(); editUserForm.classList.remove('was-validated'); }
                if(editUserPermissionsContainer) editUserPermissionsContainer.innerHTML = '<p class="text-muted">Loading...</p>';
                hideAlert(editUserFormAlert);
                if(editPrivilegeFeedback) editPrivilegeFeedback.classList.add('d-none');
                if(resetPasswordResultEl) resetPasswordResultEl.innerHTML = '';
                currentUserEmailForEdit = null;
            });
        }

        // --- REMOVED Criteria Management JS ---
        // loadCriteria, renderCriteriaCards, renderCriteriaCard, addCriteriaButtons listener, createCriteriaForm listener, etc. are all removed.

        // --- Initial Load ---
        showSection('dashboard-section'); // Show dashboard by default
        if(userTableBody) loadUsers(); // Load users on initial dashboard load
        // Removed initial loadCriteria() call

    }); // End DOMContentLoaded
</script>

</body>
</html>